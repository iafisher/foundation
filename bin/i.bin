#!/usr/bin/env bash

set -eu
source "$IAN_BASH_PRELUDE"

D="$HOME/.ian/bin"

main_add() {
  path="$(realpath "${__args[PATH]}")"
  name="${__args[--name]}"
  overwrite="${__args[--overwrite]}"

  if [[ -z "$name" ]]; then
    name="$(basename "$path")"
  fi

  [[ "$name" = */* ]] && fatal "name cannot contain slashes"
  [[ -e "$path" ]] || fatal "the path '$path' does not exist"
  [[ -f "$path" ]] || fatal "the path '$path' is not a regular file"
  [[ -x "$path" ]] || fatal "the path '$path' is not executable"

  dest="$D/$name"
  if [[ -e "$dest" ]]; then
    (( overwrite == 0 )) && fatal "the path '$dest' already exists"
    ln -sf "$path" "$dest"
    status "created link at $dest (overwriting old entry)"
  else
    ln -s "$path" "$dest"
    status "created link at $dest"
  fi
}

main_list() {
  shopt -s nullglob
  printf "%s\0" "$D"/* | while IFS= read -r -d '' file; do
    echo $(basename "$file") "-->" $(readlink "$file")
  done
  shopt -u nullglob
}

main_remove() {
  name="${__args[NAME]}"
  if [[ "$name" = */* ]]; then
    fatal "name cannot contain slashes"
  fi

  p="$D/$name"
  [[ -e "$p" ]] || [[ -L "$p" ]] || fatal "the path '$p' does not exist"

  rm -f "$p"
  status "removed executable '$name'"
}

main() {
  ian_parse_flags_subcmd \
    add 'PATH [--name=] --overwrite' \
    list '' \
    remove 'NAME' \
    -- "$@"

  case "$__subcmd" in
    add)
      main_add
      ;;
    list)
      main_list
      ;;
    remove)
      main_remove
      ;;
  esac

}

main "$@"
