# ATTENTION: This file is sourced by Bash and Zsh and must be compatible with both.

export IAN_DIR="$HOME/.ian"
export IAN_BASH_PRELUDE="$IAN_DIR/foundation/shell/bash_functions.sh"
export PATH="$PATH:$IAN_DIR/foundation/bin:$IAN_DIR/bin"
export PYTHONPATH="$PYTHONPATH:$IAN_DIR/pythonpath"

if [[ "$SHELL" = *bash ]]; then
  alias ian.refresh='unalias -a && source "$HOME/.bashrc"'
elif [[ "$SHELL" = *zsh ]]; then
  alias ian.refresh='unalias -a && source "$HOME/.zshrc"'
fi

export EDITOR="vim"

ian.cmd-exists() {
  command -v "$1" &>/dev/null
}

# `e` opens a file for editing. If `fzf` is available and the argument is a directory, a
# fuzzy-find interface is used to select the file to open.
e() {
  fuzzy() {
    # adding a slash ensures that symlinks are resolved
    local d="${1:-.}/"
    if git -C "$d" status &>/dev/null; then
      # -c includes cached files, -o includes tracked files, --exclude-standard excludes
      # ignored files
      choice="$(git -C "$d" ls-files -co --exclude-standard | fzf --exit-0)"
      [[ -n "$choice" ]] || return 1
      # `git ls-files` produces relative paths which we have to make absolute
      choice="$d/$choice"
    else
      # `find` produces absolute paths
      choice="$(find "$d" -type f | fzf --exit-0)"
    fi
    [[ -n "$choice" ]] && "$EDITOR" "$choice"
  }

  if ian.cmd-exists fzf && [[ $# -eq 0 ]] || [[ -d "$1" ]]; then
    fuzzy "$1"
  else
    "$EDITOR" "$@"
  fi

  unset fuzzy
}

# `s` shows either a directory or a file, using the commands `eza` or `bat` if available.
s() {
  ian.cmd-exists eza \
    && local ls=("eza" "--long" "--git") \
    || local ls=("ls" "-l" "--color=auto")

  ian.cmd-exists bat \
    && local cat="bat" \
    || local cat="cat"

  for arg in "$@"; do
    test -d "$arg" && ${ls[@]} "$arg" || $cat "$arg"
  done
  [[ $# -eq 0 ]] && ${ls[@]} .
}

# With no arguments, `py` is an alias for `ipython` if it exists or `python3` otherwise.
# With arguments, `py` evaluates them as a Python expression and can be used as a simple
# calculator, e.g., `py 1 + 1`
py() {
  if [[ $# -eq 0 ]]; then
    ian.cmd-exists ipython && ipython || python3
  else
    python3 -c "from decimal import Decimal as D; from math import *; print($*)"
  fi
}

alias g="git"
alias ga="git add ."
alias gd="git diff HEAD"
alias gs="git status"

# Run a single command with `set -x` (to print command invocation).
x() { ( set -x; "$@" ); }
